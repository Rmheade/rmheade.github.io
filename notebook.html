<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" type="image/x-icon" src="favicon.ico">
<title>StudyBuddy - Notebook</title>
<style>
  :root{
    --bg:#f6f8fb; 
    --card:#ffffff; 
    --muted:#6b7280; 
    --accent:#2563eb;
    --success:#10b981; 
    --danger:#ef4444; 
    --radius:12px;
    --text:#0f172a;
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }

  [data-theme="dark"] {
    --bg:#0f172a;
    --card:#1e293b;
    --muted:#94a3b8;
    --text:#f1f5f9;
  }

  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--bg), var(--bg));color:var(--text);min-height:100vh;transition:background 0.3s, color 0.3s}
  .wrap{max-width:1000px;margin:28px auto;padding:18px;min-height:calc(100vh - 56px)}
  header{display:flex;align-items:center;gap:14px;margin-bottom:18px}
  .logo{width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:20px}
  h1{font-size:20px;margin:0}
  p.lead{margin:0;color:var(--muted);font-size:13px}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:0 6px 22px rgba(16,24,40,0.06);padding:18px;margin-bottom:14px;transition:background 0.3s}
  button{background:var(--accent);color:white;border:none;padding:10px 12px;border-radius:8px;cursor:pointer;font-size:14px;transition:opacity 0.2s}
  button:disabled{opacity:0.5;cursor:not-allowed}
  button.ghost{background:transparent;color:var(--accent);border:1px solid #dbe5ff;transition:background 0.2s, border 0.2s}
  [data-theme="dark"] button.ghost{border-color:#334155}
  button.secondary{background:#6366f1;color:white}
  button.danger{background:#ef4444;color:white}
  small.note{color:var(--muted);display:block;margin-top:8px;font-size:12px}
  
  /* Notebook Tab System */
  .notebook-tabs-container {
    display: flex;
    gap: 2px;
    margin-bottom: -1px;
    position: relative;
    z-index: 10;
  }

  .notebook-tab {
    background: var(--card);
    border: 1px solid #e6e9ef;
    border-bottom: none;
    border-radius: 8px 8px 0 0;
    padding: 12px 20px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    color: var(--muted);
    transition: all 0.2s;
    position: relative;
    transform: perspective(500px) rotateX(5deg);
    transform-origin: bottom;
  }

  [data-theme="dark"] .notebook-tab {
    border-color: #334155;
  }

  .notebook-tab:hover {
    background: #f9fafb;
    color: var(--text);
    transform: perspective(500px) rotateX(2deg);
  }

  [data-theme="dark"] .notebook-tab:hover {
    background: #334155;
  }

  .notebook-tab.active {
    background: linear-gradient(180deg, var(--accent), #2563eb);
    color: white;
    border-color: var(--accent);
    transform: perspective(500px) rotateX(0deg) translateY(1px);
    box-shadow: 0 -2px 8px rgba(37, 99, 235, 0.2);
  }

  .notebook-tab.active:hover {
    background: linear-gradient(180deg, var(--accent), #1d4ed8);
  }

  .notebook-content-wrapper {
    border: 1px solid #e6e9ef;
    border-radius: 0 8px 8px 8px;
    background: var(--card);
    transition: background 0.3s, border 0.3s;
  }

  [data-theme="dark"] .notebook-content-wrapper {
    border-color: #334155;
  }

  /* Notebook Specific Styles */
  .notebook-grid {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 14px;
  }

  @media(max-width:900px){
    .notebook-grid {
      grid-template-columns: 1fr;
    }
    .notebook-sidebar {
      order: 2;
    }
  }

  .note-editor {
    min-height: 400px;
  }

  #noteContent {
    width: 100%;
    min-height: 400px;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #e6e9ef;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 14px;
    background: var(--card);
    color: var(--text);
    resize: vertical;
    transition: background 0.3s, color 0.3s, border 0.3s;
  }

  [data-theme="dark"] #noteContent {
    border-color: #334155;
  }

  #noteContent:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .notes-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .note-item {
    padding: 10px;
    border-radius: 8px;
    background: #f9fafb;
    border: 1px solid #e6e9ef;
    cursor: pointer;
    transition: all 0.2s;
  }

  [data-theme="dark"] .note-item {
    background: #334155;
    border-color: #475569;
  }

  .note-item:hover {
    border-color: var(--accent);
    background: #f0f4ff;
  }

  [data-theme="dark"] .note-item:hover {
    background: rgba(37, 99, 235, 0.15);
  }

  .note-item.active {
    background: #eef2ff;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  [data-theme="dark"] .note-item.active {
    background: rgba(37, 99, 235, 0.2);
  }

  .note-item-title {
    font-weight: 600;
    font-size: 13px;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .note-item-meta {
    font-size: 12px;
    color: var(--muted);
    margin-top: 4px;
  }

  .note-item-actions {
    display: flex;
    gap: 4px;
    margin-top: 6px;
  }

  .note-item-actions button {
    padding: 4px 8px;
    font-size: 12px;
  }

  .controls {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 10px;
  }

  .editor-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 14px;
    flex-wrap: wrap;
    gap: 10px;
  }

  #noteTitle {
    font-size: 18px;
    font-weight: 600;
    padding: 8px 0;
    border: none;
    background: transparent;
    color: var(--text);
    width: 100%;
    margin-bottom: 6px;
  }

  #noteTitle:focus {
    outline: none;
  }

  .note-meta {
    font-size: 12px;
    color: var(--muted);
  }

  .deck-link {
    background: #f0f4ff;
    border: 1px solid #dbe5ff;
    border-radius: 8px;
    padding: 8px;
    font-size: 12px;
    color: var(--accent);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  [data-theme="dark"] .deck-link {
    background: rgba(37, 99, 235, 0.1);
    border-color: rgba(37, 99, 235, 0.3);
  }

  .deck-link-remove {
    cursor: pointer;
    margin-left: auto;
  }

  input[type="text"], select {
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #e6e9ef;
    background: var(--card);
    color: var(--text);
    transition: background 0.3s, color 0.3s, border 0.3s;
  }

  [data-theme="dark"] input[type="text"], [data-theme="dark"] select {
    border-color: #334155 !important;
  }

  /* Theme Toggle Button */
  .theme-toggle-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: var(--card);
    border: 2px solid var(--accent);
    border-radius: 8px;
    cursor: pointer;
    padding: 0;
    margin-left: 8px;
    color: var(--accent);
    transition: background 0.3s, border 0.3s, color 0.3s;
  }

  .theme-toggle-btn:hover {
    background: var(--accent);
    color: white;
  }

  .theme-icon {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  /* small modal input adjustments for flash modal */
    #flashcardModal .form-group input,
    #flashcardModal .form-group select {
    width: 100%;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #e6e9ef;
    background: var(--card);
    color: var(--text);
    }
    [data-theme="dark"] #flashcardModal .form-group input,
    [data-theme="dark"] #flashcardModal .form-group select {
    border-color: #334155;
    }

</style>

<script>
// Theme Management System
class ThemeManager {
  constructor() {
    this.theme = localStorage.getItem('studybuddy-theme') || 'light';
    this.init();
  }

  init() {
    this.applyTheme(this.theme);
    this.setupButton();
    this.listenForExternalChanges();
  }

  applyTheme(theme) {
    this.theme = theme || 'light';
    document.documentElement.setAttribute('data-theme', this.theme);
    localStorage.setItem('studybuddy-theme', this.theme);
    this.updateButton();
  }

  toggle() {
    const newTheme = this.theme === 'light' ? 'dark' : 'light';
    this.applyTheme(newTheme);
  }

  setupButton() {
    const btn = document.getElementById('themeToggle');
    if (btn) {
      btn.addEventListener('click', () => this.toggle());
    }
  }

  updateButton() {
    const btn = document.getElementById('themeToggle');
    if (btn) {
      const icon = btn.querySelector('.theme-icon');
      if (icon) {
        icon.innerHTML = this.theme === 'light' 
          ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:100%;height:100%"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>'
          : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:100%;height:100%"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>';
      }
    }
  }

  listenForExternalChanges() {
    window.addEventListener('message', (event) => {
      if (event.data && event.data.type === 'THEME_CHANGED') {
        this.applyTheme(event.data.theme);
      }
      if (event.data && event.data.type === 'GET_THEME') {
        event.source.postMessage({
          type: 'THEME_CHANGED',
          theme: this.theme
        }, '*');
      }
    });
  }
}

// Initialize on DOM ready
document.addEventListener('DOMContentLoaded', () => {
  new ThemeManager();
  
  // Login modal
  document.getElementById("loginBtn").addEventListener("click", ()=>{
    document.getElementById("loginModal").style.display = "block";
  });
  
  // Listen for messages from the iframe to close the modal
  window.addEventListener('message', function(event){
    if(event.data === 'closeLogin'){
      document.getElementById("loginModal").style.display = "none";
    }
  });
  // --- Note Search ---
    document.getElementById('noteSearch').addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();

        const filtered = notes.filter(note =>
            note.title.toLowerCase().includes(query) ||
            note.content.toLowerCase().includes(query)
        );

        renderNotesList(filtered);
    });

});
</script>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">SB</div>
    <div style="flex:1">
      <h1>StudyBuddy</h1>
      <p class="lead">Your personal study companion ‚Äì create flashcards and quizzes, track your progress.</p>
    </div>
    <button id="loginBtn" class="ghost">Login</button>
    <button id="themeToggle" class="theme-toggle-btn" aria-label="Toggle Dark Mode">
      <div class="theme-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:100%;height:100%"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
      </div>
    </button>
  </header>

  <!-- Login Modal -->
  <div id="loginModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:var(--card);z-index:1000;transition:background 0.3s">
    <iframe id="loginIframe" src="pass.html" style="width:100%;height:100%;border:none"></iframe>
  </div>

  <!-- Notebook Tab System -->
  <div class="notebook-tabs-container">
    <div class="notebook-tab" data-notebook-tab="flashcards">
      <div style="display:flex;align-items:center;gap:6px">
        <span>üìö Flashcards</span>
      </div>
    </div>
    <div class="notebook-tab active" data-notebook-tab="notebook">
      <div style="display:flex;align-items:center;gap:6px">
        <span>üìù Notebook</span>
      </div>
    </div>
    <div class="notebook-tab" data-notebook-tab="calculator" onclick="window.location.href='graph.html'">
      <div style="display:flex;align-items:center;gap:6px">
        <span>üßÆ Calculator</span>
      </div>
    </div>
  </div>

  <div class="notebook-content-wrapper">
    <div class="card" style="border:none;border-radius:0 8px 8px 8px;box-shadow:none;padding:0">
      
      <div class="notebook-grid" style="padding:18px">
        <!-- Main Editor -->
        <div>
          <div class="editor-header">
            <div>
              <input type="text" id="noteTitle" placeholder="Note title..." style="width:100%;margin-bottom:6px">
              <div class="note-meta" id="noteMeta">New note</div>
            </div>
          </div>

          <div class="note-editor">
            <textarea id="noteContent" placeholder="Start typing your notes here..."></textarea>
          </div>

          <div class="controls">
            <button id="createFlashFromNote" class="ghost">Make Flashcard</button>
            <button id="saveNote">Save Note</button>
            <button id="newNote" class="ghost">New Note</button>
            <button id="deleteNote" class="danger">Delete</button>

          </div>
        </div>

        <!-- Sidebar -->
        <aside class="notebook-sidebar">
          <div class="card" style="padding:12px">
            <strong style="font-size:14px">All Notes</strong>
            <input 
            type="text" 
            id="noteSearch" 
            placeholder="Search notes..." 
            style="margin-top:8px;width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef;background:var(--card);color:var(--text);"
            />
            <div class="notes-list" id="notesList" style="margin-top:10px"></div>
          </div>

          <div class="card" style="padding:12px;margin-top:12px">
            <strong style="font-size:14px">Options</strong>
            <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
              <label style="font-size:12px;color:var(--muted)">
                <input type="checkbox" id="autoSave" checked style="margin-right:6px">
                Auto-save
              </label>
              <button id="exportNotes" class="ghost" style="font-size:12px;padding:8px">Export All</button>
              <button id="clearAllNotes" class="ghost danger" style="font-size:12px;padding:8px">Clear All</button>
            </div>
          </div>

          <div class="card" style="padding:12px;margin-top:12px">
            <strong style="font-size:14px">About</strong>
            <p style="margin:6px 0;color:var(--muted);font-size:12px">Take organized notes for your studies. Notes are saved locally in your browser.</p>
          </div>
        </aside>
      </div>

    </div>
    <!-- Flashcard modal -->
    <div id="flashcardModal" style="display:none; position:fixed; inset:0; align-items:center; justify-content:center; z-index:2000; background:rgba(0,0,0,0.35);">
        <div class="card" style="width:92%;max-width:520px; padding:18px; position:relative;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                <strong style="font-size:18px">Create Flashcard</strong>
                <button id="closeFlashModal" class="ghost" style="padding:6px 8px">‚úï</button>
            </div>

            <div class="form-group">
                <label>Front (question)</label>
                <input id="flashFront" type="text" />
            </div>

            <div class="form-group">
                <label>Back (answer)</label>
                <input id="flashBack" type="text" />
            </div>

            <div class="form-group">
                <label>Deck</label>
                <select id="flashDeckSelect"></select>
                <small class="note">Choose a deck, or create a new one below.</small>
            </div>

            <div class="form-group" style="display:flex;gap:8px;margin-top:12px">
                <input id="newDeckName" type="text" placeholder="Create new deck (optional)" style="flex:1" />
            </div>

            <div style="display:flex;gap:10px;margin-top:14px">
                <button id="addFlashConfirm" style="flex:1">Add Flashcard</button>
                <button id="addFlashCancel" class="ghost">Cancel</button>
            </div>
        </div>
    </div>

  </div>
</div>

<script>
const NOTES_KEY = "studybuddy_notes_v1";

/* State */
let notes = [];
let currentNoteId = null;
let autoSaveEnabled = true;
let autoSaveTimeout = null;

/* Utilities */
function generateId(){
  return Date.now().toString(36) + Math.random().toString(36).slice(2);
}

function loadNotes(){
  const raw = localStorage.getItem(NOTES_KEY);
  if(!raw) return [];
  try { return JSON.parse(raw); } catch(e){ return []; }
}

function saveNotes(){
  localStorage.setItem(NOTES_KEY, JSON.stringify(notes));
}

function formatDate(timestamp){
  const date = new Date(timestamp);
  const now = new Date();
  const diff = now - date;
  
  if(diff < 60000) return "Just now";
  if(diff < 3600000) return Math.floor(diff/60000) + "m ago";
  if(diff < 86400000) return Math.floor(diff/3600000) + "h ago";
  if(diff < 604800000) return Math.floor(diff/86400000) + "d ago";
  
  return date.toLocaleDateString();
}

function getNotePreview(content){
  return content.split('\n')[0].slice(0, 50) + (content.length > 50 ? "..." : "");
}

/* Initialize */
(function(){
  notes = loadNotes();
  autoSaveEnabled = localStorage.getItem('studybuddy-autosave') !== 'false';
  document.getElementById('autoSave').checked = autoSaveEnabled;
  
  renderNotesList();
  
  // If we have notes, load the first one
  if(notes.length > 0){
    loadNote(notes[0].id);
  }
  
  setupEventListeners();
  setupTabNavigation();
})();

function setupEventListeners(){
  // Save note
  document.getElementById('saveNote').addEventListener('click', () => {
    saveCurrentNote();
    alert('Note saved!');
  });
  
  // New note
  document.getElementById('newNote').addEventListener('click', () => {
    createNewNote();
  });
  
  // Delete note
  document.getElementById('deleteNote').addEventListener('click', () => {
    if(currentNoteId && confirm('Delete this note? This cannot be undone.')){
      notes = notes.filter(n => n.id !== currentNoteId);
      saveNotes();
      currentNoteId = null;
      renderNotesList();
      if(notes.length > 0){
        loadNote(notes[0].id);
      } else {
        createNewNote();
      }
    }
  });
  
  // Auto-save checkbox
  document.getElementById('autoSave').addEventListener('change', (e) => {
    autoSaveEnabled = e.target.checked;
    localStorage.setItem('studybuddy-autosave', autoSaveEnabled);
  });
  
  // Content auto-save
  const noteContent = document.getElementById('noteContent');
  noteContent.addEventListener('input', () => {
    if(autoSaveEnabled){
      clearTimeout(autoSaveTimeout);
      autoSaveTimeout = setTimeout(() => {
        saveCurrentNote(true);
      }, 1000);
    }
  });
  
  // Export notes
  document.getElementById('exportNotes').addEventListener('click', () => {
    if(notes.length === 0){
      alert('No notes to export.');
      return;
    }
    
    let content = 'StudyBuddy Notes Export\n';
    content += '=' + '='.repeat(50) + '\n\n';
    
    notes.forEach(note => {
      content += note.title + '\n';
      content += '-'.repeat(note.title.length) + '\n';
      content += 'Created: ' + new Date(note.created).toLocaleString() + '\n';
      content += 'Modified: ' + new Date(note.updated).toLocaleString() + '\n\n';
      content += note.content + '\n\n';
      content += '='.repeat(50) + '\n\n';
    });
    
    const blob = new Blob([content], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'StudyBuddy-Notes-' + new Date().toISOString().slice(0,10) + '.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });
  
  // Clear all notes
  document.getElementById('clearAllNotes').addEventListener('click', () => {
    if(confirm('Delete ALL notes? This cannot be undone.')){
      notes = [];
      saveNotes();
      currentNoteId = null;
      renderNotesList();
      createNewNote();
    }
  });
}

function setupTabNavigation(){
  document.querySelectorAll('.notebook-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      const tabName = this.getAttribute('data-notebook-tab');
      
      document.querySelectorAll('.notebook-tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      
      if(tabName === 'flashcards'){
        window.location.href = 'index.html';
      }
    });
  });
}

function createNewNote(){
  const newNote = {
    id: generateId(),
    title: 'Untitled Note',
    content: '',
    created: Date.now(),
    updated: Date.now()
  };
  
  notes.unshift(newNote);
  saveNotes();
  loadNote(newNote.id);
  renderNotesList();
  document.getElementById('noteTitle').focus();
}

function loadNote(id){
  const note = notes.find(n => n.id === id);
  if(!note) return;
  
  currentNoteId = id;
  document.getElementById('noteTitle').value = note.title;
  document.getElementById('noteContent').value = note.content;
  document.getElementById('noteMeta').textContent = 'Modified ' + formatDate(note.updated);
  
  renderNotesList();
}

function saveCurrentNote(silent = false){
  if(!currentNoteId) return;
  
  const note = notes.find(n => n.id === currentNoteId);
  if(!note) return;
  
  note.title = document.getElementById('noteTitle').value || 'Untitled Note';
  note.content = document.getElementById('noteContent').value;
  note.updated = Date.now();
  
  saveNotes();
  
  if(!silent){
    document.getElementById('noteMeta').textContent = 'Modified ' + formatDate(note.updated);
  }
  
  renderNotesList();
}

function renderNotesList(listOverride = null){
  const list = document.getElementById('notesList');
  list.innerHTML = '';

  const source = listOverride || notes;

  if (source.length === 0) {
    list.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:8px">No matching notes.</div>';
    return;
  }

  source.forEach(note => {
    const item = document.createElement('div');
    item.className = 'note-item' + (note.id === currentNoteId ? ' active' : '');

    item.innerHTML = `
      <div class="note-item-title">${note.title}</div>
      <div class="note-item-meta">${getNotePreview(note.content)}</div>
      <div class="note-item-meta">${formatDate(note.updated)}</div>
    `;

    item.addEventListener('click', () => {
      if (currentNoteId !== note.id) {
        saveCurrentNote(true);
        loadNote(note.id);
      }
    });

    list.appendChild(item);
  });
}

/* --- Flashcard-from-notes integration --- */
const DECKS_KEY = "studybuddy_decks_v2"; // same key used by index.html

function getDecks() {
  try {
    const raw = localStorage.getItem(DECKS_KEY);
    return raw ? JSON.parse(raw) : [];
  } catch (e) {
    return [];
  }
}
function saveDecksLocal(d) {
  localStorage.setItem(DECKS_KEY, JSON.stringify(d));
}

/* Modal element refs */
const flashModal = document.getElementById('flashcardModal');
const flashFront = document.getElementById('flashFront');
const flashBack = document.getElementById('flashBack');
const flashDeckSelect = document.getElementById('flashDeckSelect');
const newDeckNameInput = document.getElementById('newDeckName');

function populateDeckSelect() {
  const decks = getDecks();
  flashDeckSelect.innerHTML = '';
  const placeholderOpt = document.createElement('option');
  placeholderOpt.value = '';
  placeholderOpt.textContent = '-- Select deck --';
  flashDeckSelect.appendChild(placeholderOpt);

  decks.forEach(d => {
    const opt = document.createElement('option');
    opt.value = d.id;
    opt.textContent = d.name;
    flashDeckSelect.appendChild(opt);
  });

  // If no decks exist, prefill new deck name
  if (decks.length === 0) {
    newDeckNameInput.value = 'Notes Cards';
  } else {
    newDeckNameInput.value = '';
  }
}

function openFlashModal(prefillText = '') {
  populateDeckSelect();
  flashFront.value = prefillText || '';
  flashBack.value = '';
  newDeckNameInput.value = '';
  flashModal.style.display = 'flex';
  flashFront.focus();
}

function closeFlashModal() {
  flashModal.style.display = 'none';
}

document.getElementById('createFlashFromNote').addEventListener('click', () => {
  // try to get selection from textarea:
  const textarea = document.getElementById('noteContent');
  const sel = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd).trim();
  let prefill = sel;
  if (!prefill) {
    // fallback: current line where caret is
    const pos = textarea.selectionStart;
    const before = textarea.value.lastIndexOf('\n', pos - 1) + 1;
    const after = textarea.value.indexOf('\n', pos);
    const end = after === -1 ? textarea.value.length : after;
    prefill = textarea.value.substring(before, end).trim().slice(0, 200);
  }
  if (!prefill) {
    alert('Select some text in the note first (or place cursor on the line to use it).');
    return;
  }
  openFlashModal(prefill);
});

document.getElementById('closeFlashModal').addEventListener('click', closeFlashModal);
document.getElementById('addFlashCancel').addEventListener('click', closeFlashModal);

document.getElementById('addFlashConfirm').addEventListener('click', () => {
  const front = flashFront.value.trim();
  const back = flashBack.value.trim();
  const selectedDeckId = flashDeckSelect.value;
  const newDeckName = newDeckNameInput.value.trim();

  if (!front) {
    alert('Front cannot be empty.');
    return;
  }

  let decks = getDecks();

  let targetDeck;
  if (newDeckName) {
    // create new deck
    targetDeck = {
      id: Date.now().toString(36) + Math.random().toString(36).slice(2),
      name: newDeckName,
      cards: [],
      quizBank: [],
      sessions: [],
      notes: "",
      streak: 0,
      lastStudy: null,
      created: Date.now(),
      updated: Date.now()
    };
    decks.unshift(targetDeck);
  } else {
    targetDeck = decks.find(d => d.id === selectedDeckId);
    if (!targetDeck) {
      // fallback create default deck
      targetDeck = decks.find(d => d.name === 'Notes Cards');
      if (!targetDeck) {
        targetDeck = {
          id: Date.now().toString(36) + Math.random().toString(36).slice(2),
          name: 'Notes Cards',
          cards: [],
          quizBank: [],
          sessions: [],
          notes: "",
          streak: 0,
          lastStudy: null,
          created: Date.now(),
          updated: Date.now()
        };
        decks.unshift(targetDeck);
      }
    }
  }

  // Add the card
  targetDeck.cards = targetDeck.cards || [];
  targetDeck.cards.push({ front, back, mastered: false });
  targetDeck.updated = Date.now();

  saveDecksLocal(decks);

  // broadcast to other windows/pages (index.html will listen)
  try {
    window.postMessage({ type: 'DECKS_UPDATED' }, '*');
  } catch (e) {}

  // Hide and confirm
  closeFlashModal();
  alert('Flashcard added to "' + targetDeck.name + '"');
});

</script>
</body>
</html>