<!DOCTYPE html>
<html>
    <script>
        // Prevent direct access - only allow iframe loading
        if (window.self === window.top) {
            window.location.href = '/';
        }
    </script>
   <head>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
      <title>StudyBuddy - Personal Study Tool</title>
      <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
      <meta charset="UTF-8">
      <meta name="author" content="HimeSpider">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <style>@import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap");
         :root {
         --bg: #f6f8fb;
         --card: #ffffff;
         --muted: #6b7280;
         --accent: #2563eb;
         --accent-purple: #7c3aed;
         --radius: 12px;
         --text: #0f172a;
         }
         [data-theme="dark"] {
         --bg: #0f172a;
         --card: #1e293b;
         --muted: #94a3b8;
         --text: #f1f5f9;
         }
         body {
         background: linear-gradient(180deg, var(--bg), var(--bg));
         color: var(--text);
         font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
         margin: 0;
         overflow: auto;
         min-height: 100vh;
         transition: background 0.3s, color 0.3s;
         }
         #top-header {
         align-items: flex-start;
         background: transparent;
         box-sizing: border-box;
         display: flex;
         justify-content: center;
         left: 0;
         padding: 18px 20px;
         position: fixed;
         top: 0;
         transition: background 0.3s ease, box-shadow 0.3s ease;
         width: 100%;
         z-index: 200;
         min-height: 120px;
         }
         #top-header.scrolled {
         background: rgba(255, 255, 255, 0.95);
         box-shadow: 0 6px 22px rgba(16, 24, 40, 0.06);
         }
         [data-theme="dark"] #top-header.scrolled {
         background: rgba(30, 41, 59, 0.95);
         }
         #top-header h1 {
         color: var(--accent);
         font-family: Inter, system-ui;
         font-size: 56px;
         font-weight: 800;
         margin: 0 auto;
         letter-spacing: -0.5px;
         }

         @media (max-width: 1024px) {
         #top-header h1 {
             font-size: 44px;
         }
         }

         @media (max-width: 768px) {
         #top-header h1 {
             font-size: 32px;
         }
         }
         .header-left .updates-box {
         background: var(--card);
         border: 1px solid #e6e9ef;
         border-radius: 12px;
         box-shadow: 0 6px 22px rgba(16, 24, 40, 0.06);
         color: var(--accent);
         font-family: Inter, sans-serif;
         left: 10px;
         min-width: 180px;
         padding: 12px 14px;
         position: absolute;
         top: 10px;
         z-index: 3;
         transition: background 0.3s, border 0.3s;
         }
         [data-theme="dark"] .header-left .updates-box {
         border-color: #334155;
         }
         .header-left .updates-box h2 {
         font-size: 14px;
         font-weight: 600;
         margin: 0 0 8px 0;
         color: var(--accent);
         }
         .header-left .updates-box ul {
         list-style: none;
         padding: 0;
         margin: 0;
         font-size: 12px;
         color: var(--muted);
         }
         .header-left .updates-box li {
         margin: 4px 0;
         }
         .header-right {
         position: absolute;
         right: 20px;
         top: 18px;
         display: flex;
         flex-direction: column;
         gap: 8px;
         align-items: flex-end;
         }
         #search-container input {
         background: var(--card);
         border: 1px solid #e6e9ef;
         border-radius: 8px;
         color: var(--text);
         font-size: 0.9rem;
         outline: none;
         padding: 10px 12px;
         font-family: Inter, system-ui;
         transition: background 0.3s, border 0.3s, color 0.3s;
         width: 100%;
         box-sizing: border-box;;
         }
         [data-theme="dark"] #search-container input {
         border-color: #334155;
         }
         #search-container input::placeholder {
         color: var(--muted);
         opacity: 0.7;
         }
         p {
         color: var(--text);
         font-family: Inter, system-ui;
         font-size: 1rem;
         margin-top: 5px;
         line-height: 1.5;
         transition: color 0.3s;
         }
         #intro {
         margin: 100px auto 5%;
         text-align: center;
         max-width: 1000px;
         padding: 0 18px;
         }
         .grid {
         column-gap: 4vw;
         display: grid;
         grid-template-columns: repeat(4, 1fr);
         margin: 0 5% 5%;
         row-gap: 4vw;
         }
         .category-container {
            /* Clear the grid layout properties */
            display: block; 
            margin: 0; 
            padding: 0 5% 5%; /* Apply padding to the container instead of margin to the grid */
        }
         @media (max-width: 1200px) {
         .grid {
         grid-template-columns: repeat(3, 1fr);
         }
         }
         @media (max-width: 768px) {
         .grid {
         grid-template-columns: repeat(2, 1fr);
         }
         }
         @media (max-width: 480px) {
         .grid {
         grid-template-columns: 1fr;
         }
         }
         .game {
         background: var(--card);
         border: 1px solid #e6e9ef;
         border-radius: 12px;
         padding: 12px;
         text-align: center;
         transition: all 0.2s ease;
         box-shadow: 0 6px 22px rgba(16, 24, 40, 0.06);
         z-index: 1; 
         overflow: visible;
         position: relative;
         }
         [data-theme="dark"] .game {
         border-color: #334155;
         }
         .game:hover {
         box-shadow: 0 12px 32px rgba(37, 99, 235, 0.15);
         transform: translateY(-4px);
         border-color: #2563eb;
         z-index: 101;
         }
         .game img {
         aspect-ratio: 1/1;
         border-radius: 10px;
         display: block;
         margin-bottom: 10px;
         object-fit: cover;
         width: 100%;
         }
         .game p {
         font-size: 14px;
         font-weight: 600;
         margin: 8px 0 0;
         color: var(--text);
         transition: color 0.3s;
         }

         /* Glow animation for suggestions form */
         @keyframes glow-pulse {
           0%, 100% {
             box-shadow: 0 6px 22px rgba(16, 24, 40, 0.06),
                         0 0 20px rgba(37, 99, 235, 0.4),
                         0 0 40px rgba(37, 99, 235, 0.2);
           }
           50% {
             box-shadow: 0 6px 22px rgba(16, 24, 40, 0.06),
                         0 0 30px rgba(37, 99, 235, 0.6),
                         0 0 60px rgba(37, 99, 235, 0.3);
           }
         }

         .game.priority {
           animation: glow-pulse 2s ease-in-out infinite;
           border-color: #2563eb;
           position: relative;
         }

         .game.priority:hover {
           box-shadow: 0 12px 32px rgba(37, 99, 235, 0.25),
                       0 0 40px rgba(37, 99, 235, 0.4);
           border-color: #1d4ed8;
         }

         iframe {
         border: none;
         height: 100%;
         left: 0;
         position: absolute;
         top: 0;
         width: 100%;
         z-index: 1;
         }
         button {
         cursor: pointer;
         font-family: Inter, system-ui;
         font-weight: 600;
         }
         #back-to-top {
         align-items: center;
         background: var(--card);
         border: 1px solid #e6e9ef;
         border-radius: 8px;
         bottom: 20px;
         color: var(--accent);
         display: flex;
         font-size: 1.2rem;
         height: 48px;
         justify-content: center;
         opacity: 0;
         pointer-events: none;
         position: fixed;
         right: 20px;
         transition: all 0.3s ease;
         width: 48px;
         z-index: 4;
         box-shadow: 0 6px 22px rgba(16, 24, 40, 0.06);
         }
         [data-theme="dark"] #back-to-top {
         border-color: #334155;
         }
         #back-to-top.visible {
         opacity: 1;
         pointer-events: auto;
         }
         #back-to-top:hover {
         background: var(--accent);
         color: #ffffff;
         box-shadow: 0 12px 32px rgba(37, 99, 235, 0.2);
         transform: translateY(-2px);
         }
         #back-to-top:active {
         transform: scale(0.95);
         }
         #back-button {
         align-items: center;
         background: var(--card);
         border: 1px solid #e6e9ef;
         border-radius: 8px;
         box-shadow: 0 6px 22px rgba(16, 24, 40, 0.06);
         color: #2563eb;
         cursor: pointer;
         display: flex;
         font-family: Inter, system-ui;
         font-size: 1.2rem;
         font-weight: 700;
         height: 48px;
         justify-content: center;
         transition: all 0.2s ease;
         width: 48px;
         }
         [data-theme="dark"] #back-button {
         border-color: #334155;
         }
         #back-button:hover {
         background: #2563eb;
         color: #ffffff;
         box-shadow: 0 12px 32px rgba(37, 99, 235, 0.2);
         transform: translateY(-2px);
         }
         #back-button:active {
         box-shadow: inset 0 0 5px rgba(37, 99, 235, 0.3);
         transform: scale(0.95);
         }
         /* Theme Toggle Button */
         .theme-toggle-btn {
         display: inline-flex;
         align-items: center;
         justify-content: center;
         width: 40px;
         height: 40px;
         background: var(--card);
         border: 2px solid var(--accent);
         border-radius: 8px;
         cursor: pointer;
         padding: 0;
         color: var(--accent);
         transition: background 0.3s, border 0.3s, color 0.3s;
         }

         .theme-toggle-btn:hover {
         background: var(--accent);
         color: white;
         }

         .theme-icon {
         width: 20px;
         height: 20px;
         display: flex;
         align-items: center;
         justify-content: center;
         }
         .game .favorite-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s ease;
        }
        [data-theme="dark"] .game .favorite-btn {
            background: rgba(30, 41, 59, 0.8);
        }
        .game .favorite-btn:hover {
            transform: scale(1.1);
        }
        .game .favorite-btn.active svg {
            fill: #ef4444; /* Tailwind red-500 */
            stroke: #ef4444;
        }
        .game {
            position: relative; /* Needed for absolute positioning of the heart button */
        }
        #quick-exit-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--card);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            font-size: 0.8rem;
            font-weight: 600;
            opacity: 0.8;
            z-index: 1000;
            transition: opacity 0.3s;
        }
        #quick-exit-hint:hover {
            opacity: 1;
        }
        .game-popover {
            position: absolute;
            top: 50%;
            left: 100%;
            transform: translate(10px, -50%);
            width: 250px; 
            background: var(--card);
            border: 2px solid var(--accent);
            border-radius: var(--radius);
            padding: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            /* *** CRITICAL FIX: Increase z-index and remove clip prevention ***
            */
            z-index: 100; /* Increased to ensure it layers over all adjacent cards */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            text-align: left;
        }
        .game-popover h4 {
            margin: 0 0 8px 0;
            font-size: 1.1rem;
            color: var(--accent);
            border-bottom: 1px solid var(--bg);
            padding-bottom: 5px;
        }
        .game-popover p {
            font-size: 0.9rem;
            margin: 0;
            color: var(--text);
        }
        .game-popover .controls {
            margin-top: 10px;
            font-size: 0.8rem;
            color: var(--muted);
            font-weight: 600;
        }
        .game:hover .game-popover {
            opacity: 1;
            visibility: visible;
            transform: translate(20px, -50%); /* Slight movement effect */
        }
        /* 4-column layout (Default/ >1200px) - Target 4th, 8th, 12th, etc. */
        .grid .game:nth-child(4n):not(.priority) .game-popover {
            left: auto; /* Clear the default left: 100% */
            right: 100%; /* Stick to the left of the parent */
            /* Adjusted transform: The popover is now positioned left of the card,
               and the hover shift is to the left. */
            transform: translate(-10px, -50%); 
        }

        .grid .game:nth-child(4n):not(.priority):hover .game-popover {
            transform: translate(-20px, -50%);
        }

        /* 3-column layout (max-width: 1200px) - Target 3rd, 6th, 9th, etc. */
        @media (max-width: 1200px) {
            .grid .game:nth-child(4n):not(.priority) .game-popover {
                left: 100%;
                right: auto;
                transform: translate(10px, -50%);
            }
            .grid .game:nth-child(4n):not(.priority):hover .game-popover {
                transform: translate(20px, -50%);
            }

            .grid .game:nth-child(3n):not(.priority) .game-popover {
                left: auto;
                right: 100%;
                transform: translate(-10px, -50%);
            }
            .grid .game:nth-child(3n):not(.priority):hover .game-popover {
                transform: translate(-20px, -50%);
            }
        }

        /* 2-column layout (max-width: 768px) - Target 2nd, 4th, 6th, etc. */
        @media (max-width: 768px) {
            /* Reset 3n rule */
            .grid .game:nth-child(3n):not(.priority) .game-popover {
                left: 100%;
                right: auto;
                transform: translate(10px, -50%);
            }
            .grid .game:nth-child(3n):not(.priority):hover .game-popover {
                transform: translate(20px, -50%);
            }

            /* Apply 2n rule for the right column */
            .grid .game:nth-child(2n):not(.priority) .game-popover {
                left: auto;
                right: 100%;
                transform: translate(-10px, -50%);
            }
            .grid .game:nth-child(2n):not(.priority):hover .game-popover {
                transform: translate(-20px, -50%);
            }
        }

        /* 1-column layout (max-width: 480px) - All are 1st column, so no change needed */
        @media (max-width: 480px) {
            .grid .game:nth-child(2n):not(.priority) .game-popover {
                left: 100%;
                right: auto;
                transform: translate(10px, -50%);
            }
            .grid .game:nth-child(2n):not(.priority):hover .game-popover {
                transform: translate(20px, -50%);
            }
        }
        .control-group {
            max-width: 250px; /* Adjust this value (e.g., 200px, 300px) for desired width */
            width: 100%; 
            display: flex; /* Enable internal layout for sorting/filter groups */
            gap: 8px; /* Standard gap between internal items (selects/buttons) */
            align-items: center;
        }
        #sort-container select {
        flex-grow: 1; /* Makes them share space evenly */
        width: 0; /* Needed for correct flex behavior */
        min-width: 0;
        box-sizing: border-box;

        /* Transferred visual styles from the old inline HTML */
        background: var(--card); 
        border: 1px solid #e6e9ef; 
        border-radius: 8px; 
        color: var(--text); 
        font-size: 0.9rem; 
        outline: none; 
        padding: 10px 12px; 
        font-family: Inter, system-ui;
        transition: background 0.3s, border 0.3s, color 0.3s;
    }

    /* Re-apply dark theme border for selects */
    [data-theme="dark"] #sort-container select {
        border-color: #334155;
    }

    /* 4. Make the Favorites button take the remaining space and transfer its visual styles */
    #filter-and-theme-group #favorites-toggle {
        flex-grow: 1; /* Allows it to expand */
        text-align: center;
        padding: 10px 12px; /* Match padding of select/search input */
        
        /* Transferred visual styles from the old inline HTML */
        background: var(--card); 
        border: 1px solid var(--accent); 
        border-radius: 8px; 
        color: var(--accent); 
        font-size: 0.9rem; 
        outline: none; 
        font-family: Inter, system-ui; 
        font-weight: 600; 
        cursor: pointer;
    }
      </style>
   </head>
   <body>
      <div id="all">
      <div id="top-header">
         <div class="header-left">
            <div class="updates-box" id="updates-box">
                <h2>Site Updates</h2>
                <ul>
                    <li>PRESS '~' to quick exit!</li>
                    <li>New Dark Theme Option</li>
                    <li>Favorite Your Games!</li>
                    <li>Games Have Multiple Sort Options!</li>
                </ul>
            </div>
         </div>
         <h1>HIMESPIDER</h1>
         <div class="header-right">
            <div class="control-group" id="search-wrapper"> 
                <div id="search-container"><input type="text" id="search-bar" placeholder="Search..."></div>
            </div>
            
            <div class="control-group" id="sort-container"> 
                <select id="category-filter-select">
                    <option value="all">All Categories</option>
                </select>
                <select id="sort-select">
                    <option value="name-asc">A-Z (Name)</option>
                    <option value="name-desc">Z-A (Name)</option>
                    <option value="added-desc">Recently Added</option>
                    <option value="category-asc">Category</option>
                </select>
            </div>
            
            <div class="control-group" id="filter-and-theme-group"> 
                <button id="favorites-toggle">
                    Show Favorites
                </button>
                <button id="themeToggle" class="theme-toggle-btn" aria-label="Toggle Dark Mode">
                  <div class="theme-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:100%;height:100%"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                  </div>
                </button>
            </div>
        </div>
      </div>
      <div style="height:80px"></div>
      <div>
        <p id="intro">Welcome! This website will fufill your Unbl0cked g@me needs. It is password locked, so no admin can get in, and all games open on the same URL, meaning that there is no way in without the password. <strong>To exit a game, you can move your mouse to the top right corner and a button will appear to exit the game and return to the home website without logging in. Have Fun!</strong><br><br>Yours Truly,<br>HimeSpider</p>
      </div>

      <div class="grid" id="games-grid">
         
      </div>

      <a id="back-to-top" href="#" aria-label="Back to top">
         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up"><path d="m18 15-6-6-6 6"/></svg>
      </a>

    </div>
    
    <script src="games.js"></script>

    <script>
        // Assign a simple ID (index) to each game for sorting purposes
        const allGames = baseGames.map((game, index) => ({
            ...game,
            id: index,
            // For simplicity, we'll use the index to represent "Recently Added" (higher index = newer)
        }));

        // Local Storage Key
        const FAVORITES_KEY = 'studybuddy-favorites';

        // Function to toggle a game's favorite status
        function toggleFavorite(gameName) {
            let favorites = JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]');
            const index = favorites.indexOf(gameName);
            
            if (index > -1) {
                favorites.splice(index, 1); // Remove
            } else {
                favorites.push(gameName); // Add
            }
            
            localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites));
            sortAndFilterGames(); // Re-render the grid to update icons/filters
        }

        // Function to check if a game is a favorite
        function isFavorite(gameName) {
            const favorites = JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]');
            return favorites.includes(gameName);
        }

        // State variable for the favorites filter
        let isShowingFavorites = false;

        // --- Core Rendering Logic ---
        function renderGames(gamesToRender) {
            const grid = document.getElementById('games-grid');
            if (!grid) return;

            // FIX: Reset the main container's class to 'grid' to re-enable the column layout
            grid.className = 'grid'; 

            // Clear existing games
            grid.innerHTML = '';

            gamesToRender.forEach(game => {
                const gameDiv = document.createElement('div');
                gameDiv.className = 'game';

                if (game.isPriority) {
                    gameDiv.classList.add('priority');
                }

                const clickHandler = game.isExternal
                    ? `window.open('${game.url}', '_blank')`
                    : `beep('${game.url}')`;

                gameDiv.setAttribute('onclick', clickHandler);

                const isFav = isFavorite(game.name);
                const favoriteClass = isFav ? ' active' : '';
                
                const favoriteButtonHTML = game.isPriority ? '' : `
                    <button class="favorite-btn${favoriteClass}" 
                            onclick="event.stopPropagation(); toggleFavorite('${game.name}')" 
                            aria-label="Toggle Favorite">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart">
                            <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>
                        </svg>
                    </button>
                `;

                gameDiv.innerHTML = `
                    ${favoriteButtonHTML}
                    <img loading="lazy" src="${game.image}">
                    <p>${game.name}</p>
                    
                    ${game.description ? `
                        <div class="game-popover">
                            <h4>${game.name}</h4>
                            <p>${game.description}</p>
                            ${game.controls ? `<div class="controls">Controls: ${game.controls}</div>` : ''}
                        </div>
                    ` : ''}
                `;
                grid.appendChild(gameDiv);
            });
        }

        // --- New Grouped Rendering Logic---
        function renderGamesGroupedByCategory(gamesToRender) {
            const container = document.getElementById('games-grid');
            if (!container) return;

            //Set the main container class to the non-grid styling
            container.className = 'category-container';

            // Clear existing games/grid (we'll replace the grid with a container)
            container.innerHTML = '';
            
            // Temporarily change the ID or remove the class to clear default grid CSS
            container.className = 'category-container';
            
            // Group games by category
            const groupedGames = gamesToRender.reduce((acc, game) => {
                const category = game.category || 'Other';
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(game);
                return acc;
            }, {});
            
            // Get sorted category names
            const sortedCategories = Object.keys(groupedGames).sort((a, b) => {
                // Ensure 'Other' is at the bottom
                if (a === 'Other') return 1;
                if (b === 'Other') return -1;
                return a.localeCompare(b);
            });

            sortedCategories.forEach(category => {
                const games = groupedGames[category];

                // 1. Create Category Header
                const header = document.createElement('h2');
                header.style.cssText = 'margin: 40px 5% 15px; font-size: 1.8rem; border-bottom: 2px solid var(--accent); padding-bottom: 5px; color: var(--text);';
                header.textContent = category;
                container.appendChild(header);

                // 2. Create Category Grid (Use the original 'grid' class for styling)
                const categoryGrid = document.createElement('div');
                categoryGrid.className = 'grid'; // <-- This correctly applies the grid layout to the sub-sections
                
                // 3. Populate the Grid with Games
                games.forEach(game => {
                    // *** Re-use the same game rendering logic from the original renderGames function ***
                    const gameDiv = document.createElement('div');
                    gameDiv.className = 'game';

                    if (game.isPriority) {
                        gameDiv.classList.add('priority');
                    }

                    const clickHandler = game.isExternal
                        ? `window.open('${game.url}', '_blank')`
                        : `beep('${game.url}')`;

                    gameDiv.setAttribute('onclick', clickHandler);
            
                    const isFav = isFavorite(game.name);
                    const favoriteClass = isFav ? ' active' : '';
                    
                    const favoriteButtonHTML = game.isPriority ? '' : `
                        <button class="favorite-btn${favoriteClass}" 
                                onclick="event.stopPropagation(); toggleFavorite('${game.name}')" 
                                aria-label="Toggle Favorite">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart">
                                <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>
                            </svg>
                        </button>
                    `;

                    gameDiv.innerHTML = `
                        ${favoriteButtonHTML}
                        <img loading="lazy" src="${game.image}">
                        <p>${game.name}</p>
                        
                        ${game.description ? `
                            <div class="game-popover">
                                <h4>${game.name}</h4>
                                <p>${game.description}</p>
                                ${game.controls ? `<div class="controls">Controls: ${game.controls}</div>` : ''}
                            </div>
                        ` : ''}
                    `;
                    categoryGrid.appendChild(gameDiv);
                });

                container.appendChild(categoryGrid);
            });
        }

        // --- Function to Setup Category Filter Dropdown (NEW) ---
        function extractAndSetupCategoryFilter() {
            // 1. Get all unique categories
            const categories = new Set();
            allGames.forEach(game => {
                if (game.category) {
                    categories.add(game.category);
                }
            });

            // 2. Prepare the dropdown and base options
            const filterSelect = document.getElementById('category-filter-select');
            if (!filterSelect) return;

            // Start with 'All Categories' option
            filterSelect.innerHTML = '<option value="all">All Categories</option>';
            
            // Convert Set to Array, sort alphabetically, and add 'Other' last
            const sortedCategories = Array.from(categories).sort((a, b) => {
                // Optional: Exclude 'Other' if you handle it elsewhere, but this is safer
                if (a === 'Other') return 1; 
                if (b === 'Other') return -1;
                return a.localeCompare(b);
            });

            // 3. Populate the dropdown
            sortedCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                filterSelect.appendChild(option);
            });
            
            // Add event listener to re-render games when the filter changes
            filterSelect.addEventListener('change', sortAndFilterGames);
        }

        // --- Core Filtering and Sorting Logic ---
        function sortAndFilterGames() {
            const searchBar = document.getElementById('search-bar');
            const sortSelect = document.getElementById('sort-select'); 
            
            // Get the selected category filter
            const categoryFilterSelect = document.getElementById('category-filter-select');
            const selectedCategory = categoryFilterSelect ? categoryFilterSelect.value : 'all';

            const searchTerm = searchBar ? searchBar.value.toLowerCase() : '';
            const sortOption = sortSelect ? sortSelect.value : 'name-asc'; 

            // 1. Filter games
            let filteredGames = allGames.filter(game => {
                const nameMatch = game.name.toLowerCase().includes(searchTerm);
                const isFav = isFavorite(game.name);
                const favMatch = !isShowingFavorites || isFav;
                
                // Check if the game matches the selected category
                const gameCategory = game.category || 'Other';
                const categoryMatch = selectedCategory === 'all' || gameCategory === selectedCategory;

                // Combine all filters
                return (nameMatch && favMatch && categoryMatch) || game.isPriority;
            });

            // 2. Apply sorting (RE-INSERTED COMPARISON LOGIC)
            filteredGames.sort((a, b) => {
                // Keep priority game at the very top, always overriding other sorts
                if (a.isPriority && !b.isPriority) return -1; 
                if (b.isPriority && !a.isPriority) return 1;

                switch (sortOption) {
                    case 'name-asc':
                        return a.name.localeCompare(b.name);
                    case 'name-desc':
                        return b.name.localeCompare(a.name);
                    case 'added-desc':
                        // Higher ID (index) means more recently added
                        return b.id - a.id; 
                    case 'category-asc': 
                        const categoryA = a.category || 'Other';
                        const categoryB = b.category || 'Other';
                        const categoryComparison = categoryA.localeCompare(categoryB);
                        if (categoryComparison !== 0) {
                            return categoryComparison;
                        }
                        // Secondary sort by name
                        return a.name.localeCompare(b.name);
                    default:
                        // Fallback to name-asc
                        return a.name.localeCompare(b.name);
                }
            });

            // 3. Conditional Rendering (This remains correct)
            if (sortOption === 'category-asc' && searchTerm === '') {
                renderGamesGroupedByCategory(filteredGames);
            } else {
                renderGames(filteredGames);
            }
        }

        function setupControls() {
            const searchBar = document.getElementById('search-bar');
            const sortSelect = document.getElementById('sort-select');
            const favoritesToggle = document.getElementById('favorites-toggle');

            if (searchBar) {
                searchBar.addEventListener('input', sortAndFilterGames);
            }
            if (sortSelect) {
                sortSelect.addEventListener('change', sortAndFilterGames);
            }

            // Favorites Toggle Listener
            if (favoritesToggle) {
                favoritesToggle.addEventListener('click', () => {
                    isShowingFavorites = !isShowingFavorites; // Flip the state
                    favoritesToggle.textContent = isShowingFavorites ? 'Show All Games' : 'Show Favorites';
                    
                    // Apply a visual style when the filter is active (optional)
                    favoritesToggle.style.borderColor = isShowingFavorites ? '#7c3aed' : '#2563eb';
                    favoritesToggle.style.color = isShowingFavorites ? '#7c3aed' : '#2563eb';

                    sortAndFilterGames(); // Rerun the full filter/sort/render cycle
                });
            }
            
            // Initial check to set button state if coming back to the page
            if (favoritesToggle) {
                favoritesToggle.textContent = isShowingFavorites ? 'Show All Games' : 'Show Favorites';
            }
        }
        // --- Theme Management (unchanged) ---
        // Apply theme immediately from localStorage
        const theme = localStorage.getItem('studybuddy-theme') || 'light';
        document.documentElement.setAttribute('data-theme', theme);
        
        // Theme Management Class
        class ThemeManager {
            constructor() {
                this.theme = localStorage.getItem('studybuddy-theme') || 'light';
                this.init();
            }
            init() {
                this.applyTheme(this.theme);
                this.setupButton();
                this.listenForExternalChanges();
            }
            applyTheme(theme) {
                this.theme = theme || 'light';
                document.documentElement.setAttribute('data-theme', this.theme);
                localStorage.setItem('studybuddy-theme', this.theme);
                this.updateButton();
                this.broadcastToParent();
            }
            toggle() {
                const newTheme = this.theme === 'light' ? 'dark' : 'light';
                this.applyTheme(newTheme);
            }
            setupButton() {
                const btn = document.getElementById('themeToggle');
                if (btn) {
                    btn.addEventListener('click', () => this.toggle());
                }
            }
            updateButton() {
                const btn = document.getElementById('themeToggle');
                if (btn) {
                    const icon = btn.querySelector('.theme-icon');
                    if (icon) {
                        icon.innerHTML = this.theme === 'light' 
                            ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:100%;height:100%"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>'
                            : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:100%;height:100%"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="4.22" x2="19.78" y2="5.64"></line></svg>';
                    }
                }
            }
            broadcastToParent() {
                 if (window.parent !== window.self) {
                     window.parent.postMessage({ theme: this.theme }, '*');
                 }
            }
            listenForExternalChanges() {
                window.addEventListener('message', (event) => {
                    if (event.data.theme && event.data.theme !== this.theme) {
                        this.applyTheme(event.data.theme);
                    }
                });
            }
        }

        // --- Game Iframe/Exit Button Logic (unchanged) ---
        function beep(t) {
            window.appState.isInGame = true;
            const n = document.createElement("iframe");
            n.setAttribute("src", t);
            n.style.position = "fixed";
            n.style.top = "0";
            n.style.left = "0";
            n.style.width = "100%";
            n.style.height = "100%";
            n.style.zIndex = "1000";
            document.getElementById("all").hidden = true;
            const o = document.body.style.overflow;
            document.body.style.overflow = "hidden";
            const l = document.createElement("a");
            l.id = "back-button";
            l.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>';
            l.style.opacity = "0";
            l.style.pointerEvents = "none";
            l.style.position = "fixed";
            l.style.top = "20px";
            l.style.right = "20px";
            l.style.zIndex = "1002";
            let d = null, i = !1;
            const s = document.createElement("div");
            s.style.position = "fixed";
            s.style.top = "0";
            s.style.right = "0";
            s.style.width = "100px";
            s.style.height = "100px";
            s.style.zIndex = "1001";
            s.style.background = "transparent";
            s.style.pointerEvents = "auto";
            
            function r() {
                d && (clearTimeout(d), d = null);
                l.style.opacity = "1";
                l.style.pointerEvents = "auto";
            }
            function a() {
                i || (d && clearTimeout(d), d = setTimeout(() => {
                    i || (l.style.opacity = "0", l.style.pointerEvents = "none");
                }, 400));
            }

            s.addEventListener("mouseenter", r);
            s.addEventListener("mouseleave", () => {
                d && clearTimeout(d);
                d = setTimeout(() => {
                    i || (l.style.opacity = "0", l.style.pointerEvents = "none");
                }, 100);
            });
            l.addEventListener("mouseenter", () => {
                i = !0;
                r();
            });
            l.addEventListener("mouseleave", () => {
                i = !1;
                a();
            });
            
            l.onclick = function() {
                window.appState.isInGame = false;
                document.body.removeChild(n);
                document.body.removeChild(l);
                document.body.removeChild(s);
                document.getElementById("all").hidden = false;
                document.body.style.overflow = o;
            };

            document.body.appendChild(n);
            document.body.appendChild(s);
            document.body.appendChild(l);
            // FIX: Focus the iframe so keyboard events are captured properly
            n.addEventListener('load', function() {
                try {
                    n.focus();
                    n.contentWindow.focus();
                } catch (e) {
                    console.error("Could not focus iframe contentWindow:", e);
                }
            });
        }
        
        document.addEventListener('keydown', (e) => {
            if (e.key === '`') {
                console.log('Backtick pressed!');
                const backButton = document.getElementById('back-button');
                
                if (window.appState && window.appState.isInGame && backButton) {
                    console.log('In game - exiting');
                    e.preventDefault();
                    backButton.click();
                } else if (!window.appState || !window.appState.isInGame) {
                    console.log('Not in game - sending parent message');
                    e.preventDefault();
                    if (window.parent !== window.self) {
                        console.log('Sending tilde-pressed to parent');
                        window.parent.postMessage({ type: 'tilde-pressed' }, '*'); 
                    } else {
                        console.log('No parent window found');
                    }
                }
            }
        });

        // App State for Quick Exit Logic
        window.appState = { isInGame: false };


        // --- Document Ready and Event Listeners ---
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize Theme Manager
            new ThemeManager();
                        
            // Header Scroll and Back-to-Top Logic
            const topHeader = document.getElementById("top-header");
            const backToTop = document.getElementById("back-to-top");

            // Update header appearance on scroll
            window.addEventListener("scroll", () => {
                if (topHeader) {
                    if (window.scrollY > 0) topHeader.classList.add("scrolled");
                    else topHeader.classList.remove("scrolled");
                }

                if (backToTop) {
                    if (window.scrollY > 300) backToTop.classList.add("visible");
                    else backToTop.classList.remove("visible");
                }
            });

            if (backToTop) {
                backToTop.addEventListener("click", (e) => {
                    e.preventDefault();
                    window.scrollTo({ top: 0, behavior: "smooth" });
                });
            }

            extractAndSetupCategoryFilter();

            // Initial setup - **This now calls the new JS functions to render games**
            sortAndFilterGames();
            setupControls();
        });
    </script>
    <div id="quick-exit-hint">
        Press `~` (tilde) to Quick Exit
    </div>
   </body>
</html>